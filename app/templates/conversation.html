<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>Conversation - Driven Dynamics</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <style>
        :root{
            --accent1: #667eea;
            --accent2: #764ba2;
            --bg-grad: linear-gradient(135deg, var(--accent1) 0%, var(--accent2) 100%);
        }
        *{box-sizing: border-box;}
        body { font-family: 'Montserrat', sans-serif; background: var(--bg-grad); min-height:100vh; margin:0; padding:40px 20px; position: relative; }

        /* Enhanced animated background */
        .background-animation{ 
            position:fixed; 
            inset:0; 
            z-index:0; 
            overflow:hidden; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .shape{ 
            position:absolute; 
            border-radius:50%; 
            background: rgba(255,255,255,0.1); 
            backdrop-filter: blur(10px);
            animation: float 20s infinite ease-in-out;
        }
        
        .shape-1{ 
            width:350px;
            height:350px; 
            top:-120px; 
            left:-120px;
            animation-delay: 0s;
        }
        
        .shape-2{ 
            width:450px;
            height:450px; 
            bottom:-180px; 
            right:-180px;
            animation-delay: 5s;
        }
        
        .shape-3 {
            width: 280px;
            height: 280px;
            top: 45%;
            left: 55%;
            animation-delay: 10s;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) scale(1); }
            25% { transform: translate(50px, -50px) scale(1.1); }
            50% { transform: translate(-30px, 30px) scale(0.9); }
            75% { transform: translate(30px, 50px) scale(1.05); }
        }

        .thread { position:relative; z-index:10; max-width:980px; margin:0 auto; }
        
        /* Enhanced page title card */
        .page-title{ 
            background: rgba(255,255,255,0.95); 
            backdrop-filter: blur(10px);
            padding:25px; 
            border-radius:20px; 
            margin-bottom:25px; 
            text-align:center;
            box-shadow: 0 15px 50px rgba(0,0,0,0.25);
            position: relative;
        }
        
        .page-title::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px 20px 0 0;
        }
        
        .page-title h3{ 
            color:var(--accent1); 
            margin:0;
            font-size: 28px;
            font-weight: 700;
        }

        .thread-wrap{ display:flex; gap:25px; align-items:flex-start; }
        
        /* Enhanced messages column */
        .messages-col{ 
            flex:1; 
            background: rgba(255,255,255,0.95); 
            backdrop-filter: blur(10px);
            padding:30px; 
            border-radius:20px; 
            box-shadow:0 15px 50px rgba(0,0,0,0.25);
        }
        
        .meta { font-size:12px; color:#666; margin-bottom:6px; }

        .message { 
            max-width:75%; 
            padding:14px 18px; 
            border-radius:14px; 
            margin-bottom:15px; 
            background: #fff; 
            color:#222; 
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .message:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }
        
        .message.me{ 
            margin-left:auto; 
            background: linear-gradient(135deg, rgba(102,126,234,0.15), rgba(118,75,162,0.15)); 
            border:2px solid rgba(102,126,234,0.25);
        }
        
        .message .body{ white-space:pre-wrap; }
        .message .who{ font-weight:700; color:var(--accent2); }

        .side-col{ width:280px; min-width:200px; }
        
        .product-card{ 
            background: rgba(255,255,255,0.95); 
            backdrop-filter: blur(10px);
            padding:25px; 
            border-radius:20px; 
            box-shadow:0 15px 50px rgba(0,0,0,0.25);
            margin-bottom: 20px;
            border: 2px solid rgba(102,126,234,0.15);
            transition: all 0.3s ease;
        }
        
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .product-card p{ 
            margin:10px 0;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .product-card strong {
            color: var(--accent1);
            font-weight: 700;
        }

        form.reply-form{ 
            margin-top:20px; 
            background: rgba(255,255,255,0.95); 
            padding:25px; 
            border-radius:20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            border: 2px solid rgba(102,126,234,0.1);
        }
        
        .form-control {
            border: 2px solid rgba(102,126,234,0.3);
            border-radius: 10px;
            padding: 12px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            font-weight: 700;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            font-weight: 700;
        }
        
        .btn-outline-secondary {
            border: 2px solid #667eea; /* Changed to visible color for mobile */
            color: #667eea;
            background: rgba(255,255,255,0.8);
            border-radius: 10px;
            padding: 8px 20px;
            font-weight: 600;
        }
        
        .badge {
            padding: 6px 12px;
            border-radius: 8px;
            font-weight: 700;
        }

        /* MOBILE FIXES */
        @media (max-width:880px){ 
            body { padding: 15px 10px; }
            .thread-wrap{ flex-direction:column; } 
            .side-col{ width:100%; order: -1; } /* Moves product info to top on mobile */
            .message{ max-width:100%; } 
            .messages-col { padding: 20px; }
            .page-title h3 { font-size: 20px; margin-top: 40px; }
            .btn-outline-secondary { position: static !important; display: block; width: fit-content; margin-bottom: 10px; }
            .d-flex.gap-2 { flex-direction: column; } /* Stack Send/Dismiss buttons */
            .btn-primary, .btn-secondary { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="background-animation">
        <div class="shape shape-1"></div>
        <div class="shape shape-2"></div>
        <div class="shape shape-3"></div>
    </div>

    <div class="thread">
        <div class="page-title">
            <a href="/retrieve_seller" class="btn btn-outline-secondary">&larr; Back</a>
            <h3><i class="bi bi-chat-dots-fill"></i> Conversation</h3>
        </div>

        <div class="thread-wrap">
            <div class="messages-col">
                {% if conversation.ProductID %}
                    <div class="product-card mb-3">
                        <p><strong><i class="bi bi-box-seam"></i> Product:</strong> {{ conversation.ProductID }}</p>
                    </div>
                {% endif %}

                <div id="messages">
                    {% for msg in conversation.messages %}
                        {% set is_me = (msg.from == session.get('user_email')) %}
                        <div class="message {{ 'me' if is_me else '' }}">
                            <div class="meta"><span class="who">{{ msg.name or msg.from }}</span> â€” <small>{{ msg.timestamp }}</small></div>
                            <div class="body">{{ msg.message }}</div>
                        </div>
                    {% endfor %}
                </div>

                <form method="POST" action="" class="reply-form">
                    <div class="mb-2">
                        <label for="name"><strong><i class="bi bi-person-fill"></i> Your name</strong></label>
                        <input id="name" name="name" class="form-control" value="{{ session.get('user_name','') }}">
                    </div>
                    <div class="mb-2">
                        <label for="message"><strong><i class="bi bi-chat-left-text-fill"></i> Message</strong></label>
                        <textarea id="message" name="message" class="form-control" rows="4" required></textarea>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-primary" type="submit"><i class="bi bi-send-fill"></i> Send Reply</button>
                        <form method="post" action="/conversation/{{ conversation.ConversationID if conversation.ConversationID else conversation._id }}/dismiss" onsubmit="return confirm('Are you sure you want to delete this conversation?');">
                            <button class="btn btn-secondary" type="submit"><i class="bi bi-trash-fill"></i> Dismiss</button>
                        </form>
                    </div>
                </form>
            </div>

            <div class="side-col">
                <div class="product-card">
                    {# Prefer an email for Buyer: if Conversation.BuyerEmail doesn't look like an email, try the first message 'from' value #}
                    {% set buyer_display = conversation.BuyerEmail %}
                    {% if conversation.messages and (not buyer_display or '@' not in buyer_display) %}
                        {% set buyer_display = conversation.messages[0].from %}
                    {% endif %}
                    <p><strong><i class="bi bi-cart-fill"></i> Buyer:</strong> {{ buyer_display or 'Unknown' }}</p>
                    <p><strong><i class="bi bi-shop"></i> Seller:</strong> {{ conversation.SellerEmail }}</p>
                    <p><strong><i class="bi bi-calendar-event"></i> Started:</strong> {{ conversation.created_at }}</p>
                    {% if conversation.unread_by and session.get('user_email') in conversation.unread_by %}
                        <p><span class="badge bg-danger"><i class="bi bi-bell-fill"></i> NEW</span> You have unread messages</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</body>
</html>